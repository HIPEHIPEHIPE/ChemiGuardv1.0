<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChemiGuard í‘œì¤€í™” ì—”ì§„ v2.0</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background: #f5f7fa;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .control-panel {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .btn {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: #3730a3;
            transform: translateY(-1px);
        }
        
        .btn-success { background: #10b981; }
        .btn-success:hover { background: #047857; }
        
        .btn-warning { background: #f59e0b; color: white; }
        .btn-warning:hover { background: #d97706; }
        
        .btn-danger { background: #ef4444; }
        .btn-danger:hover { background: #dc2626; }
        
        .btn-secondary { background: #6b7280; }
        .btn-secondary:hover { background: #4b5563; }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .panel h3 {
            margin: 0 0 20px 0;
            color: #1f2937;
            font-size: 1.4em;
            font-weight: 600;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid;
        }
        
        .stat-card.total { border-left-color: #6366f1; }
        .stat-card.success { border-left-color: #10b981; }
        .stat-card.error { border-left-color: #ef4444; }
        .stat-card.warning { border-left-color: #f59e0b; }
        .stat-card.info { border-left-color: #3b82f6; }
        
        .stat-number {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #1f2937;
        }
        
        .stat-label {
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #34d399);
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .log-container {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 8px 12px;
            border-radius: 6px;
            border-left: 3px solid;
        }
        
        .log-info { background: #eff6ff; border-left-color: #3b82f6; color: #1e40af; }
        .log-success { background: #f0fdf4; border-left-color: #10b981; color: #166534; }
        .log-error { background: #fef2f2; border-left-color: #ef4444; color: #dc2626; }
        .log-warning { background: #fffbeb; border-left-color: #f59e0b; color: #d97706; }
        
        .stage-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            transition: all 0.3s ease;
        }
        
        .stage-card.active {
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .stage-card.completed {
            border-color: #10b981;
            background: #f0fdf4;
        }
        
        .stage-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .stage-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }
        
        .stage-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-pending { background: #f3f4f6; color: #6b7280; }
        .status-running { background: #dbeafe; color: #1d4ed8; }
        .status-completed { background: #d1fae5; color: #065f46; }
        .status-failed { background: #fee2e2; color: #dc2626; }
        
        .issues-container {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .issue-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            transition: all 0.2s ease;
        }
        
        .issue-item:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .issue-error { border-left: 4px solid #ef4444; }
        .issue-warning { border-left: 4px solid #f59e0b; }
        .issue-suggestion { border-left: 4px solid #3b82f6; }
        .issue-fixed { border-left: 4px solid #10b981; background: #f0fdf4; }
        
        .issue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .issue-title {
            font-weight: 600;
            color: #1f2937;
        }
        
        .issue-type {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .type-error { background: #fee2e2; color: #dc2626; }
        .type-warning { background: #fef3c7; color: #d97706; }
        .type-suggestion { background: #dbeafe; color: #1d4ed8; }
        .type-fixed { background: #d1fae5; color: #065f46; }
        
        .issue-details {
            color: #6b7280;
            margin: 8px 0;
        }
        
        .issue-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 6px;
        }
        
        .fix-preview {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 12px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 13px;
        }
        
        .fix-before {
            color: #dc2626;
            text-decoration: line-through;
        }
        
        .fix-after {
            color: #059669;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ§ª ChemiGuard í‘œì¤€í™” ì—”ì§„</h1>
        <p>í™”í•™ì œí’ˆ ë°ì´í„° í‘œì¤€í™” ë° í’ˆì§ˆ ê²€ì¦ ë„êµ¬ v2.0</p>
    </div>

    <div class="control-panel">
        <h3>ğŸ›ï¸ ì œì–´íŒ</h3>
        <button class="btn" onclick="startFullStandardization()">ì™„ì „ í‘œì¤€í™” ì‹œì‘</button>
        <button class="btn btn-success" onclick="startQuickValidation()">ë¹ ë¥¸ ê²€ì¦</button>
        <button class="btn btn-warning" onclick="loadTestData()">í…ŒìŠ¤íŠ¸ ë°ì´í„° ë¡œë“œ</button>
        <button class="btn btn-secondary" onclick="exportResults()">ê²°ê³¼ ë‚´ë³´ë‚´ê¸°</button>
        <button class="btn btn-danger" onclick="resetAll()">ì „ì²´ ì´ˆê¸°í™”</button>
    </div>

    <div class="grid">
        <div class="panel">
            <h3>ğŸ“Š ì§„í–‰ í˜„í™©</h3>
            <div class="stats-grid">
                <div class="stat-card total">
                    <div class="stat-number" id="total-records">0</div>
                    <div class="stat-label">ì´ ë ˆì½”ë“œ</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-number" id="completed-records">0</div>
                    <div class="stat-label">ì™„ë£Œ</div>
                </div>
                <div class="stat-card error">
                    <div class="stat-number" id="error-records">0</div>
                    <div class="stat-label">ì˜¤ë¥˜</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-number" id="warning-records">0</div>
                    <div class="stat-label">ê²½ê³ </div>
                </div>
            </div>
            
            <div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span>ì „ì²´ ì§„í–‰ë„</span>
                    <span id="progress-percentage">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div class="panel">
            <h3>ğŸ“ ì‹¤í–‰ ë¡œê·¸</h3>
            <div id="logs" class="log-container">
                <div class="log-entry log-info">í‘œì¤€í™” ì—”ì§„ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
            </div>
        </div>
    </div>

    <div class="panel">
        <h3>ğŸ”§ í‘œì¤€í™” ë‹¨ê³„</h3>
        <div id="standardization-stages">
            <!-- ë‹¨ê³„ë“¤ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
        </div>
    </div>

    <div class="panel">
        <h3>ğŸ› ê°ì§€ëœ ì´ìŠˆ</h3>
        <div id="issues-display" class="issues-container">
            <div class="log-entry log-info">ì´ìŠˆê°€ ê°ì§€ë˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>
    </div>

    <script>
        // í‘œì¤€í™” ì—”ì§„ ìƒíƒœ
        let standardizationState = {
            isRunning: false,
            currentStage: 0,
            totalRecords: 0,
            processedRecords: 0,
            issues: [],
            stages: [],
            results: {}
        };

        // í‘œì¤€í™” ë‹¨ê³„ ì •ì˜
        const STANDARDIZATION_STAGES = [
            {
                id: 'data-loading',
                name: 'ë°ì´í„° ë¡œë”©',
                description: 'ì›ë³¸ ë°ì´í„°ë¥¼ ë©”ëª¨ë¦¬ë¡œ ë¡œë“œí•©ë‹ˆë‹¤',
                weight: 10
            },
            {
                id: 'basic-validation',
                name: 'ê¸°ë³¸ ê²€ì¦',
                description: 'í•„ìˆ˜ í•„ë“œ ë° ë°ì´í„° íƒ€ì…ì„ ê²€ì¦í•©ë‹ˆë‹¤',
                weight: 15
            },
            {
                id: 'cas-standardization',
                name: 'CAS ë²ˆí˜¸ í‘œì¤€í™”',
                description: 'CAS ë²ˆí˜¸ í˜•ì‹ì„ í‘œì¤€í™”í•˜ê³  ê²€ì¦í•©ë‹ˆë‹¤',
                weight: 20
            },
            {
                id: 'ingredient-normalization',
                name: 'ì„±ë¶„ëª… ì •ê·œí™”',
                description: 'ì„±ë¶„ëª…ì„ í‘œì¤€ í˜•íƒœë¡œ ì •ê·œí™”í•©ë‹ˆë‹¤',
                weight: 25
            },
            {
                id: 'percentage-validation',
                name: 'í•¨ëŸ‰ ê²€ì¦',
                description: 'í•¨ëŸ‰ ë°ì´í„°ì˜ ìœ íš¨ì„±ì„ ê²€ì¦í•©ë‹ˆë‹¤',
                weight: 15
            },
            {
                id: 'cross-validation',
                name: 'êµì°¨ ê²€ì¦',
                description: 'ë°ì´í„° ê°„ ì¼ê´€ì„±ì„ ê²€ì¦í•©ë‹ˆë‹¤',
                weight: 10
            },
            {
                id: 'quality-assessment',
                name: 'í’ˆì§ˆ í‰ê°€',
                description: 'ìµœì¢… ë°ì´í„° í’ˆì§ˆì„ í‰ê°€í•©ë‹ˆë‹¤',
                weight: 5
            }
        ];

        // ë¡œê·¸ í•¨ìˆ˜
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logs');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `${new Date().toLocaleTimeString()} - ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats() {
            const { totalRecords, processedRecords, issues } = standardizationState;
            
            document.getElementById('total-records').textContent = totalRecords;
            document.getElementById('completed-records').textContent = processedRecords;
            
            const errorCount = issues.filter(i => i.type === 'error').length;
            const warningCount = issues.filter(i => i.type === 'warning').length;
            
            document.getElementById('error-records').textContent = errorCount;
            document.getElementById('warning-records').textContent = warningCount;
            
            const progress = totalRecords > 0 ? Math.round((processedRecords / totalRecords) * 100) : 0;
            document.getElementById('progress-percentage').textContent = `${progress}%`;
            document.getElementById('progress-fill').style.width = `${progress}%`;
        }

        // ë‹¨ê³„ UI ìƒì„±
        function createStagesUI() {
            const container = document.getElementById('standardization-stages');
            container.innerHTML = '';
            
            STANDARDIZATION_STAGES.forEach((stage, index) => {
                const stageElement = document.createElement('div');
                stageElement.className = 'stage-card';
                stageElement.id = `stage-${stage.id}`;
                
                stageElement.innerHTML = `
                    <div class="stage-header">
                        <h4 class="stage-title">${index + 1}. ${stage.name}</h4>
                        <span class="stage-status status-pending" id="status-${stage.id}">ëŒ€ê¸°ì¤‘</span>
                    </div>
                    <p style="color: #6b7280; margin: 0;">${stage.description}</p>
                    <div class="progress-bar" style="margin-top: 10px;">
                        <div class="progress-fill" id="progress-${stage.id}" style="width: 0%"></div>
                    </div>
                `;
                
                container.appendChild(stageElement);
            });
        }

        // ë‹¨ê³„ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateStageStatus(stageId, status, progress = 0) {
            const stageElement = document.getElementById(`stage-${stageId}`);
            const statusElement = document.getElementById(`status-${stageId}`);
            const progressElement = document.getElementById(`progress-${stageId}`);
            
            if (stageElement && statusElement && progressElement) {
                // ì´ì „ ìƒíƒœ í´ë˜ìŠ¤ ì œê±°
                stageElement.classList.remove('active', 'completed');
                statusElement.className = `stage-status status-${status}`;
                
                switch (status) {
                    case 'running':
                        stageElement.classList.add('active');
                        statusElement.textContent = 'ì‹¤í–‰ì¤‘';
                        break;
                    case 'completed':
                        stageElement.classList.add('completed');
                        statusElement.textContent = 'ì™„ë£Œ';
                        break;
                    case 'failed':
                        statusElement.textContent = 'ì‹¤íŒ¨';
                        break;
                    default:
                        statusElement.textContent = 'ëŒ€ê¸°ì¤‘';
                }
                
                progressElement.style.width = `${progress}%`;
            }
        }

        // CAS ë²ˆí˜¸ í‘œì¤€í™” í•¨ìˆ˜
        function standardizeCASNumber(casNumber) {
            if (!casNumber || typeof casNumber !== 'string') {
                return { 
                    standardized: null, 
                    isValid: false, 
                    issues: ['CAS ë²ˆí˜¸ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.'] 
                };
            }
            
            const cleaned = casNumber.trim().replace(/[^0-9-]/g, '');
            const issues = [];
            
            // ê¸°ë³¸ í˜•ì‹ ê²€ì¦
            const casRegex = /^\\d{2,7}-\\d{2}-\\d$/;
            
            if (casRegex.test(cleaned)) {
                // ì²´í¬ì„¬ ê²€ì¦
                const parts = cleaned.split('-');
                const digits = (parts[0] + parts[1]).split('').reverse();
                const checkDigit = parseInt(parts[2]);
                
                let sum = 0;
                for (let i = 0; i < digits.length; i++) {
                    sum += parseInt(digits[i]) * (i + 1);
                }
                
                const calculatedCheck = sum % 10;
                
                if (calculatedCheck === checkDigit) {
                    return { 
                        standardized: cleaned, 
                        isValid: true, 
                        issues: [] 
                    };
                } else {
                    issues.push(`CAS ë²ˆí˜¸ ì²´í¬ì„¬ ì˜¤ë¥˜ (ê³„ì‚°ê°’: ${calculatedCheck}, ì…ë ¥ê°’: ${checkDigit})`);
                }
            }
            
            // ìë™ ìˆ˜ì • ì‹œë„
            if (/^\\d{5,9}$/.test(cleaned)) {
                const digits = cleaned;
                if (digits.length >= 7) {
                    const suggested = `${digits.slice(0, -3)}-${digits.slice(-3, -1)}-${digits.slice(-1)}`;
                    return {
                        standardized: suggested,
                        isValid: false,
                        issues: [`í˜•ì‹ ì˜¤ë¥˜ - ì œì•ˆê°’: ${suggested}`],
                        autoFixSuggestion: suggested
                    };
                }
            }
            
            return {
                standardized: cleaned,
                isValid: false,
                issues: ['CAS ë²ˆí˜¸ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.']
            };
        }

        // ì„±ë¶„ëª… ì •ê·œí™” í•¨ìˆ˜
        function normalizeIngredientName(name) {
            if (!name || typeof name !== 'string') {
                return {
                    normalized: null,
                    isValid: false,
                    issues: ['ì„±ë¶„ëª…ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.']
                };
            }
            
            const issues = [];
            let normalized = name.trim();
            
            // ê³µí†µ ì •ê·œí™” ê·œì¹™
            const normalizationRules = [
                { pattern: /ì†Œë“/g, replacement: 'ë‚˜íŠ¸ë¥¨' },
                { pattern: /í¬íƒ€ìŠ˜/g, replacement: 'ì¹¼ë¥¨' },
                { pattern: /í´ë¡œë¼ì´ë“œ/g, replacement: 'ì—¼í™”ë¬¼' },
                { pattern: /ì„¤í˜ì´íŠ¸/g, replacement: 'í™©ì‚°ì—¼' },
                { pattern: /í•˜ì´ë“œë¡ì‚¬ì´ë“œ/g, replacement: 'ìˆ˜ì‚°í™”ë¬¼' },
                { pattern: /\\s+/g, replacement: ' ' },
                { pattern: /^\\s+|\\s+$/g, replacement: '' }
            ];
            
            let wasNormalized = false;
            const originalName = normalized;
            
            normalizationRules.forEach(rule => {
                const newValue = normalized.replace(rule.pattern, rule.replacement);
                if (newValue !== normalized) {
                    normalized = newValue;
                    wasNormalized = true;
                }
            });
            
            // ìœ íš¨ì„± ê²€ì‚¬
            if (normalized.length < 2) {
                issues.push('ì„±ë¶„ëª…ì´ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤.');
            }
            
            if (/[0-9]{5,}/.test(normalized)) {
                issues.push('ì„±ë¶„ëª…ì— ê¸´ ìˆ«ìê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
            }
            
            if (/ì˜ëª»ëœ|ì˜¤ë¥˜|ì—ëŸ¬|unknown/i.test(normalized)) {
                issues.push('ì„±ë¶„ëª…ì— ì˜¤ë¥˜ í‘œì‹œê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
            }
            
            return {
                normalized: normalized,
                isValid: issues.length === 0,
                issues: issues,
                wasNormalized: wasNormalized,
                originalValue: wasNormalized ? originalName : null
            };
        }

        // í•¨ëŸ‰ ê²€ì¦ í•¨ìˆ˜
        function validatePercentage(percentage) {
            const issues = [];
            
            if (percentage === null || percentage === undefined || percentage === '') {
                return {
                    validated: null,
                    isValid: false,
                    issues: ['í•¨ëŸ‰ ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.']
                };
            }
            
            const numValue = parseFloat(percentage);
            
            if (isNaN(numValue)) {
                issues.push('í•¨ëŸ‰ì´ ìˆ«ìê°€ ì•„ë‹™ë‹ˆë‹¤.');
                return {
                    validated: percentage,
                    isValid: false,
                    issues: issues
                };
            }
            
            let validated = numValue;
            
            // ë²”ìœ„ ê²€ì¦
            if (numValue < 0) {
                issues.push('í•¨ëŸ‰ì´ ìŒìˆ˜ì…ë‹ˆë‹¤.');
                // ìë™ ìˆ˜ì • ì œì•ˆ
                return {
                    validated: validated,
                    isValid: false,
                    issues: issues,
                    autoFixSuggestion: Math.abs(numValue)
                };
            }
            
            if (numValue > 100) {
                issues.push('í•¨ëŸ‰ì´ 100%ë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.');
            }
            
            // ì†Œìˆ˜ì  ìë¦¬ìˆ˜ ì •ê·œí™”
            if (numValue % 1 !== 0) {
                validated = Math.round(numValue * 100) / 100; // ì†Œìˆ˜ì  2ìë¦¬ê¹Œì§€
            }
            
            return {
                validated: validated,
                isValid: issues.length === 0,
                issues: issues
            };
        }

        // ë ˆì½”ë“œ í‘œì¤€í™” í•¨ìˆ˜
        function standardizeRecord(record) {
            const issues = [];
            const standardized = { ...record };
            
            // CAS ë²ˆí˜¸ í‘œì¤€í™”
            if (record.cas_number) {
                const casResult = standardizeCASNumber(record.cas_number);
                standardized.cas_number = casResult.standardized;
                
                if (!casResult.isValid) {
                    issues.push({
                        id: `cas-${record.id}`,
                        type: 'error',
                        field: 'cas_number',
                        title: 'CAS ë²ˆí˜¸ ì˜¤ë¥˜',
                        description: casResult.issues.join(', '),
                        originalValue: record.cas_number,
                        suggestedValue: casResult.autoFixSuggestion,
                        autoFixable: !!casResult.autoFixSuggestion
                    });
                }
            }
            
            // ì„±ë¶„ëª… ì •ê·œí™”
            if (record.ingredient_name) {
                const nameResult = normalizeIngredientName(record.ingredient_name);
                standardized.ingredient_name = nameResult.normalized;
                
                if (!nameResult.isValid) {
                    issues.push({
                        id: `name-${record.id}`,
                        type: 'warning',
                        field: 'ingredient_name',
                        title: 'ì„±ë¶„ëª… ì´ìŠˆ',
                        description: nameResult.issues.join(', '),
                        originalValue: record.ingredient_name,
                        suggestedValue: nameResult.normalized,
                        autoFixable: nameResult.wasNormalized
                    });
                } else if (nameResult.wasNormalized) {
                    issues.push({
                        id: `name-normalized-${record.id}`,
                        type: 'suggestion',
                        field: 'ingredient_name',
                        title: 'ì„±ë¶„ëª… ì •ê·œí™”',
                        description: 'ì„±ë¶„ëª…ì´ í‘œì¤€ í˜•íƒœë¡œ ì •ê·œí™”ë˜ì—ˆìŠµë‹ˆë‹¤.',
                        originalValue: nameResult.originalValue,
                        suggestedValue: nameResult.normalized,
                        autoFixable: true
                    });
                }
            }
            
            // í•¨ëŸ‰ ê²€ì¦
            if (record.percentage !== undefined) {
                const percentResult = validatePercentage(record.percentage);
                standardized.percentage = percentResult.validated;
                
                if (!percentResult.isValid) {
                    issues.push({
                        id: `percentage-${record.id}`,
                        type: percentResult.autoFixSuggestion ? 'warning' : 'error',
                        field: 'percentage',
                        title: 'í•¨ëŸ‰ ì˜¤ë¥˜',
                        description: percentResult.issues.join(', '),
                        originalValue: record.percentage,
                        suggestedValue: percentResult.autoFixSuggestion,
                        autoFixable: !!percentResult.autoFixSuggestion
                    });
                }
            }
            
            return {
                standardized: standardized,
                issues: issues
            };
        }

        // ì´ìŠˆ í‘œì‹œ í•¨ìˆ˜
        function displayIssues(issues) {
            const container = document.getElementById('issues-display');
            container.innerHTML = '';
            
            if (issues.length === 0) {
                container.innerHTML = '<div class="log-entry log-success">ê°ì§€ëœ ì´ìŠˆê°€ ì—†ìŠµë‹ˆë‹¤! ğŸ‰</div>';
                return;
            }
            
            const groupedIssues = issues.reduce((groups, issue) => {
                const key = issue.type;
                if (!groups[key]) groups[key] = [];
                groups[key].push(issue);
                return groups;
            }, {});
            
            Object.entries(groupedIssues).forEach(([type, typeIssues]) => {
                const groupHeader = document.createElement('div');
                groupHeader.innerHTML = `<h4 style="margin: 20px 0 10px 0; color: #374151;">${type.toUpperCase()} (${typeIssues.length}ê±´)</h4>`;
                container.appendChild(groupHeader);
                
                typeIssues.forEach(issue => {
                    const issueElement = document.createElement('div');
                    issueElement.className = `issue-item issue-${issue.type}`;
                    
                    issueElement.innerHTML = `
                        <div class="issue-header">
                            <div class="issue-title">${issue.title}</div>
                            <span class="issue-type type-${issue.type}">${issue.type}</span>
                        </div>
                        <div class="issue-details">
                            <strong>ì„¤ëª…:</strong> ${issue.description}<br>
                            <strong>í•„ë“œ:</strong> ${issue.field}<br>
                            ${issue.originalValue ? `<strong>ì›ë³¸ê°’:</strong> ${issue.originalValue}<br>` : ''}
                            ${issue.suggestedValue ? `<strong>ì œì•ˆê°’:</strong> ${issue.suggestedValue}<br>` : ''}
                            <strong>ìë™ìˆ˜ì •:</strong> ${issue.autoFixable ? 'ê°€ëŠ¥' : 'ë¶ˆê°€ëŠ¥'}
                        </div>
                        ${issue.suggestedValue ? `
                            <div class="fix-preview">
                                <div class="fix-before">- ${issue.originalValue}</div>
                                <div class="fix-after">+ ${issue.suggestedValue}</div>
                            </div>
                        ` : ''}
                        <div class="issue-actions">
                            ${issue.autoFixable ? `<button class="btn btn-success btn-small" onclick="applyFix('${issue.id}')">ìˆ˜ì • ì ìš©</button>` : ''}
                            <button class="btn btn-secondary btn-small" onclick="ignoreIssue('${issue.id}')">ë¬´ì‹œ</button>
                        </div>
                    `;
                    
                    container.appendChild(issueElement);
                });
            });
        }

        // í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±
        function createTestData() {
            return [
                {
                    id: 'test-1',
                    product_name: 'ë‹¤ëª©ì  ì„¸ì œ',
                    ingredient_name: 'ì†Œë“ë¼ìš°ë¦´ì„¤í˜ì´íŠ¸',
                    cas_number: '151213',
                    percentage: 15.5,
                    category: 'ì„¸ì œ'
                },
                {
                    id: 'test-2',
                    product_name: 'ì†ì„¸ì •ì œ',
                    ingredient_name: 'ì—í‹¸ì•Œì½”ì˜¬',
                    cas_number: '64-17-5',
                    percentage: -5,
                    category: 'ì„¸ì •ì œ'
                },
                {
                    id: 'test-3',
                    product_name: 'ìœ ë¦¬ì„¸ì •ì œ',
                    ingredient_name: 'ì˜ëª»ëœì„±ë¶„ëª…',
                    cas_number: '123-45-6',
                    percentage: 105,
                    category: 'ì„¸ì •ì œ'
                },
                {
                    id: 'test-4',
                    product_name: 'ë°”ë‹¥ì„¸ì •ì œ',
                    ingredient_name: 'ì•”ëª¨ë‹ˆì•„',
                    cas_number: '7664-41-7',
                    percentage: 8.25,
                    category: 'ì„¸ì •ì œ'
                },
                {
                    id: 'test-5',
                    product_name: 'í™”ì¥ì‹¤ì„¸ì •ì œ',
                    ingredient_name: 'í¬íƒ€ìŠ˜í•˜ì´ë“œë¡ì‚¬ì´ë“œ',
                    cas_number: '',
                    percentage: null,
                    category: 'ì„¸ì •ì œ'
                }
            ];
        }

        // ì™„ì „ í‘œì¤€í™” ì‹¤í–‰
        async function startFullStandardization() {
            if (standardizationState.isRunning) {
                addLog('í‘œì¤€í™”ê°€ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.', 'warning');
                return;
            }
            
            standardizationState.isRunning = true;
            addLog('ì™„ì „ í‘œì¤€í™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...', 'info');
            
            // í…ŒìŠ¤íŠ¸ ë°ì´í„° ë¡œë“œ
            const testData = createTestData();
            standardizationState.totalRecords = testData.length;
            standardizationState.processedRecords = 0;
            standardizationState.issues = [];
            
            updateStats();
            
            // ê° ë‹¨ê³„ ì‹¤í–‰
            for (let i = 0; i < STANDARDIZATION_STAGES.length; i++) {
                const stage = STANDARDIZATION_STAGES[i];
                
                addLog(`ë‹¨ê³„ ${i + 1}: ${stage.name} ì‹œì‘`, 'info');
                updateStageStatus(stage.id, 'running');
                
                // ë‹¨ê³„ë³„ ì²˜ë¦¬ ì‹œë®¬ë ˆì´ì…˜
                await simulateStageExecution(stage, testData);
                
                updateStageStatus(stage.id, 'completed', 100);
                addLog(`ë‹¨ê³„ ${i + 1}: ${stage.name} ì™„ë£Œ`, 'success');
            }
            
            standardizationState.isRunning = false;
            addLog('í‘œì¤€í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            updateStats();
        }

        // ë‹¨ê³„ ì‹¤í–‰ ì‹œë®¬ë ˆì´ì…˜
        async function simulateStageExecution(stage, data) {
            const stepCount = 10;
            
            for (let step = 0; step < stepCount; step++) {
                await new Promise(resolve => setTimeout(resolve, 200));
                
                const progress = ((step + 1) / stepCount) * 100;
                updateStageStatus(stage.id, 'running', progress);
                
                // íŠ¹ì • ë‹¨ê³„ì—ì„œ ì‹¤ì œ ì²˜ë¦¬ ìˆ˜í–‰
                if (stage.id === 'cas-standardization' && step === 5) {
                    data.forEach(record => {
                        const result = standardizeRecord(record);
                        standardizationState.issues.push(...result.issues);
                    });
                    
                    displayIssues(standardizationState.issues);
                }
                
                if (step === stepCount - 1) {
                    standardizationState.processedRecords = Math.min(
                        standardizationState.processedRecords + Math.ceil(data.length / STANDARDIZATION_STAGES.length),
                        standardizationState.totalRecords
                    );
                    updateStats();
                }
            }
        }

        // ë¹ ë¥¸ ê²€ì¦
        async function startQuickValidation() {
            addLog('ë¹ ë¥¸ ê²€ì¦ì„ ì‹œì‘í•©ë‹ˆë‹¤...', 'info');
            
            const testData = createTestData();
            const allIssues = [];
            
            testData.forEach(record => {
                const result = standardizeRecord(record);
                allIssues.push(...result.issues);
            });
            
            standardizationState.issues = allIssues;
            standardizationState.totalRecords = testData.length;
            standardizationState.processedRecords = testData.length;
            
            updateStats();
            displayIssues(allIssues);
            
            addLog(`ë¹ ë¥¸ ê²€ì¦ ì™„ë£Œ: ${allIssues.length}ê±´ì˜ ì´ìŠˆ ë°œê²¬`, 'success');
        }

        // ìˆ˜ì • ì ìš©
        function applyFix(issueId) {
            addLog(`ì´ìŠˆ ${issueId}ì— ëŒ€í•œ ìˆ˜ì •ì„ ì ìš©í–ˆìŠµë‹ˆë‹¤.`, 'success');
            
            // í•´ë‹¹ ì´ìŠˆë¥¼ 'fixed' ìƒíƒœë¡œ ë³€ê²½
            const issue = standardizationState.issues.find(i => i.id === issueId);
            if (issue) {
                issue.type = 'fixed';
                issue.title = '[ìˆ˜ì •ë¨] ' + issue.title;
                displayIssues(standardizationState.issues);
            }
        }

        // ì´ìŠˆ ë¬´ì‹œ
        function ignoreIssue(issueId) {
            standardizationState.issues = standardizationState.issues.filter(i => i.id !== issueId);
            displayIssues(standardizationState.issues);
            addLog(`ì´ìŠˆ ${issueId}ë¥¼ ë¬´ì‹œí–ˆìŠµë‹ˆë‹¤.`, 'info');
        }

        // í…ŒìŠ¤íŠ¸ ë°ì´í„° ë¡œë“œ
        function loadTestData() {
            addLog('í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ë¡œë“œí•©ë‹ˆë‹¤...', 'info');
            const testData = createTestData();
            addLog(`${testData.length}ê°œì˜ í…ŒìŠ¤íŠ¸ ë ˆì½”ë“œë¥¼ ë¡œë“œí–ˆìŠµë‹ˆë‹¤.`, 'success');
        }

        // ê²°ê³¼ ë‚´ë³´ë‚´ê¸°
        function exportResults() {
            const results = {
                timestamp: new Date().toISOString(),
                totalRecords: standardizationState.totalRecords,
                processedRecords: standardizationState.processedRecords,
                issues: standardizationState.issues,
                summary: {
                    errorCount: standardizationState.issues.filter(i => i.type === 'error').length,
                    warningCount: standardizationState.issues.filter(i => i.type === 'warning').length,
                    suggestionCount: standardizationState.issues.filter(i => i.type === 'suggestion').length,
                    fixedCount: standardizationState.issues.filter(i => i.type === 'fixed').length
                }
            };
            
            const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `standardization-results-${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            addLog('ê²°ê³¼ë¥¼ JSON íŒŒì¼ë¡œ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤.', 'success');
        }

        // ì „ì²´ ì´ˆê¸°í™”
        function resetAll() {
            standardizationState = {
                isRunning: false,
                currentStage: 0,
                totalRecords: 0,
                processedRecords: 0,
                issues: [],
                stages: [],
                results: {}
            };
            
            updateStats();
            
            // ëª¨ë“  ë‹¨ê³„ ì´ˆê¸°í™”
            STANDARDIZATION_STAGES.forEach(stage => {
                updateStageStatus(stage.id, 'pending', 0);
            });
            
            document.getElementById('issues-display').innerHTML = '<div class="log-entry log-info">ì´ìŠˆê°€ ê°ì§€ë˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>';
            document.getElementById('logs').innerHTML = '';
            
            addLog('ì‹œìŠ¤í…œì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            createStagesUI();
            updateStats();
            addLog('í‘œì¤€í™” ì—”ì§„ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        });
    </script>
</body>
</html>