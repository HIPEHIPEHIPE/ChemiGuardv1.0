<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChemiGuard ÌëúÏ§ÄÌôî ÏóîÏßÑ v2.0</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background: #f5f7fa;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .control-panel {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .btn {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: #3730a3;
            transform: translateY(-1px);
        }
        
        .btn-success { background: #10b981; }
        .btn-success:hover { background: #047857; }
        
        .btn-warning { background: #f59e0b; color: white; }
        .btn-warning:hover { background: #d97706; }
        
        .btn-danger { background: #ef4444; }
        .btn-danger:hover { background: #dc2626; }
        
        .btn-secondary { background: #6b7280; }
        .btn-secondary:hover { background: #4b5563; }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .panel h3 {
            margin: 0 0 20px 0;
            color: #1f2937;
            font-size: 1.4em;
            font-weight: 600;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid;
        }
        
        .stat-card.total { border-left-color: #6366f1; }
        .stat-card.success { border-left-color: #10b981; }
        .stat-card.error { border-left-color: #ef4444; }
        .stat-card.warning { border-left-color: #f59e0b; }
        .stat-card.info { border-left-color: #3b82f6; }
        
        .stat-number {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #1f2937;
        }
        
        .stat-label {
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #34d399);
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .log-container {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 8px 12px;
            border-radius: 6px;
            border-left: 3px solid;
        }
        
        .log-info { background: #eff6ff; border-left-color: #3b82f6; color: #1e40af; }
        .log-success { background: #f0fdf4; border-left-color: #10b981; color: #166534; }
        .log-error { background: #fef2f2; border-left-color: #ef4444; color: #dc2626; }
        .log-warning { background: #fffbeb; border-left-color: #f59e0b; color: #d97706; }
        
        .stage-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            transition: all 0.3s ease;
        }
        
        .stage-card.active {
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .stage-card.completed {
            border-color: #10b981;
            background: #f0fdf4;
        }
        
        .stage-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .stage-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }
        
        .stage-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-pending { background: #f3f4f6; color: #6b7280; }
        .status-running { background: #dbeafe; color: #1d4ed8; }
        .status-completed { background: #d1fae5; color: #065f46; }
        .status-failed { background: #fee2e2; color: #dc2626; }
        
        .issues-container {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .issue-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            transition: all 0.2s ease;
        }
        
        .issue-item:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .issue-error { border-left: 4px solid #ef4444; }
        .issue-warning { border-left: 4px solid #f59e0b; }
        .issue-suggestion { border-left: 4px solid #3b82f6; }
        .issue-fixed { border-left: 4px solid #10b981; background: #f0fdf4; }
        
        .issue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .issue-title {
            font-weight: 600;
            color: #1f2937;
        }
        
        .issue-type {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .type-error { background: #fee2e2; color: #dc2626; }
        .type-warning { background: #fef3c7; color: #d97706; }
        .type-suggestion { background: #dbeafe; color: #1d4ed8; }
        .type-fixed { background: #d1fae5; color: #065f46; }
        
        .issue-details {
            color: #6b7280;
            margin: 8px 0;
        }
        
        .issue-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 6px;
        }
        
        .fix-preview {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 12px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 13px;
        }
        
        .fix-before {
            color: #dc2626;
            text-decoration: line-through;
        }
        
        .fix-after {
            color: #059669;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üß™ ChemiGuard ÌëúÏ§ÄÌôî ÏóîÏßÑ</h1>
        <p>ÌôîÌïôÏ†úÌíà Îç∞Ïù¥ÌÑ∞ ÌëúÏ§ÄÌôî Î∞è ÌíàÏßà Í≤ÄÏ¶ù ÎèÑÍµ¨ v2.0</p>
    </div>

    <div class="control-panel">
        <h3>üéõÔ∏è Ï†úÏñ¥Ìåê</h3>
        <button class="btn" onclick="startFullStandardization()">ÏôÑÏ†Ñ ÌëúÏ§ÄÌôî ÏãúÏûë</button>
        <button class="btn btn-success" onclick="startQuickValidation()">Îπ†Î•∏ Í≤ÄÏ¶ù</button>
        <button class="btn btn-warning" onclick="loadTestData()">ÌÖåÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìú</button>
        <button class="btn btn-secondary" onclick="exportResults()">Í≤∞Í≥º ÎÇ¥Î≥¥ÎÇ¥Í∏∞</button>
        <button class="btn btn-danger" onclick="resetAll()">Ï†ÑÏ≤¥ Ï¥àÍ∏∞Ìôî</button>
    </div>

    <div class="grid">
        <div class="panel">
            <h3>üìä ÏßÑÌñâ ÌòÑÌô©</h3>
            <div class="stats-grid">
                <div class="stat-card total">
                    <div class="stat-number" id="total-records">0</div>
                    <div class="stat-label">Ï¥ù Î†àÏΩîÎìú</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-number" id="completed-records">0</div>
                    <div class="stat-label">ÏôÑÎ£å</div>
                </div>
                <div class="stat-card error">
                    <div class="stat-number" id="error-records">0</div>
                    <div class="stat-label">Ïò§Î•ò</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-number" id="warning-records">0</div>
                    <div class="stat-label">Í≤ΩÍ≥†</div>
                </div>
            </div>
            
            <div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span>Ï†ÑÏ≤¥ ÏßÑÌñâÎèÑ</span>
                    <span id="progress-percentage">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div class="panel">
            <h3>üìù Ïã§Ìñâ Î°úÍ∑∏</h3>
            <div id="logs" class="log-container">
                <div class="log-entry log-info">ÌëúÏ§ÄÌôî ÏóîÏßÑÏù¥ Ï§ÄÎπÑÎêòÏóàÏäµÎãàÎã§.</div>
            </div>
        </div>
    </div>

    <div class="panel">
        <h3>üîß ÌëúÏ§ÄÌôî Îã®Í≥Ñ</h3>
        <div id="standardization-stages">
            <!-- Îã®Í≥ÑÎì§Ïù¥ ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê©ÎãàÎã§ -->
        </div>
    </div>

    <div class="panel">
        <h3>üêõ Í∞êÏßÄÎêú Ïù¥Ïäà</h3>
        <div id="issues-display" class="issues-container">
            <div class="log-entry log-info">Ïù¥ÏäàÍ∞Ä Í∞êÏßÄÎêòÎ©¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§.</div>
        </div>
    </div>

    <script>
        // ÌëúÏ§ÄÌôî ÏóîÏßÑ ÏÉÅÌÉú
        let standardizationState = {
            isRunning: false,
            currentStage: 0,
            totalRecords: 0,
            processedRecords: 0,
            issues: [],
            stages: [],
            results: {}
        };

        // ÌëúÏ§ÄÌôî Îã®Í≥Ñ Ï†ïÏùò
        const STANDARDIZATION_STAGES = [
            {
                id: 'data-loading',
                name: 'Îç∞Ïù¥ÌÑ∞ Î°úÎî©',
                description: 'ÏõêÎ≥∏ Îç∞Ïù¥ÌÑ∞Î•º Î©îÎ™®Î¶¨Î°ú Î°úÎìúÌï©ÎãàÎã§',
                weight: 10
            },
            {
                id: 'basic-validation',
                name: 'Í∏∞Î≥∏ Í≤ÄÏ¶ù',
                description: 'ÌïÑÏàò ÌïÑÎìú Î∞è Îç∞Ïù¥ÌÑ∞ ÌÉÄÏûÖÏùÑ Í≤ÄÏ¶ùÌï©ÎãàÎã§',
                weight: 15
            },
            {
                id: 'cas-standardization',
                name: 'CAS Î≤àÌò∏ ÌëúÏ§ÄÌôî',
                description: 'CAS Î≤àÌò∏ ÌòïÏãùÏùÑ ÌëúÏ§ÄÌôîÌïòÍ≥† Í≤ÄÏ¶ùÌï©ÎãàÎã§',
                weight: 20
            },
            {
                id: 'ingredient-normalization',
                name: 'ÏÑ±Î∂ÑÎ™Ö Ï†ïÍ∑úÌôî',
                description: 'ÏÑ±Î∂ÑÎ™ÖÏùÑ ÌëúÏ§Ä ÌòïÌÉúÎ°ú Ï†ïÍ∑úÌôîÌï©ÎãàÎã§',
                weight: 25
            },
            {
                id: 'percentage-validation',
                name: 'Ìï®Îüâ Í≤ÄÏ¶ù',
                description: 'Ìï®Îüâ Îç∞Ïù¥ÌÑ∞Ïùò Ïú†Ìö®ÏÑ±ÏùÑ Í≤ÄÏ¶ùÌï©ÎãàÎã§',
                weight: 15
            },
            {
                id: 'cross-validation',
                name: 'ÍµêÏ∞® Í≤ÄÏ¶ù',
                description: 'Îç∞Ïù¥ÌÑ∞ Í∞Ñ ÏùºÍ¥ÄÏÑ±ÏùÑ Í≤ÄÏ¶ùÌï©ÎãàÎã§',
                weight: 10
            },
            {
                id: 'quality-assessment',
                name: 'ÌíàÏßà ÌèâÍ∞Ä',
                description: 'ÏµúÏ¢Ö Îç∞Ïù¥ÌÑ∞ ÌíàÏßàÏùÑ ÌèâÍ∞ÄÌï©ÎãàÎã§',
                weight: 5
            }
        ];

        // Î°úÍ∑∏ Ìï®Ïàò
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logs');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `${new Date().toLocaleTimeString()} - ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
        function updateStats() {
            const { totalRecords, processedRecords, issues } = standardizationState;
            
            document.getElementById('total-records').textContent = totalRecords;
            document.getElementById('completed-records').textContent = processedRecords;
            
            const errorCount = issues.filter(i => i.type === 'error').length;
            const warningCount = issues.filter(i => i.type === 'warning').length;
            
            document.getElementById('error-records').textContent = errorCount;
            document.getElementById('warning-records').textContent = warningCount;
            
            const progress = totalRecords > 0 ? Math.round((processedRecords / totalRecords) * 100) : 0;
            document.getElementById('progress-percentage').textContent = `${progress}%`;
            document.getElementById('progress-fill').style.width = `${progress}%`;
        }

        // Îã®Í≥Ñ UI ÏÉùÏÑ±
        function createStagesUI() {
            const container = document.getElementById('standardization-stages');
            container.innerHTML = '';
            
            STANDARDIZATION_STAGES.forEach((stage, index) => {
                const stageElement = document.createElement('div');
                stageElement.className = 'stage-card';
                stageElement.id = `stage-${stage.id}`;
                
                stageElement.innerHTML = `
                    <div class="stage-header">
                        <h4 class="stage-title">${index + 1}. ${stage.name}</h4>
                        <span class="stage-status status-pending" id="status-${stage.id}">ÎåÄÍ∏∞Ï§ë</span>
                    </div>
                    <p style="color: #6b7280; margin: 0;">${stage.description}</p>
                    <div class="progress-bar" style="margin-top: 10px;">
                        <div class="progress-fill" id="progress-${stage.id}" style="width: 0%"></div>
                    </div>
                `;
                
                container.appendChild(stageElement);
            });
        }

        // Îã®Í≥Ñ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        function updateStageStatus(stageId, status, progress = 0) {
            const stageElement = document.getElementById(`stage-${stageId}`);
            const statusElement = document.getElementById(`status-${stageId}`);
            const progressElement = document.getElementById(`progress-${stageId}`);
            
            if (stageElement && statusElement && progressElement) {
                // Ïù¥Ï†Ñ ÏÉÅÌÉú ÌÅ¥ÎûòÏä§ Ï†úÍ±∞
                stageElement.classList.remove('active', 'completed');
                statusElement.className = `stage-status status-${status}`;
                
                switch (status) {
                    case 'running':
                        stageElement.classList.add('active');
                        statusElement.textContent = 'Ïã§ÌñâÏ§ë';
                        break;
                    case 'completed':
                        stageElement.classList.add('completed');
                        statusElement.textContent = 'ÏôÑÎ£å';
                        break;
                    case 'failed':
                        statusElement.textContent = 'Ïã§Ìå®';
                        break;
                    default:
                        statusElement.textContent = 'ÎåÄÍ∏∞Ï§ë';
                }
                
                progressElement.style.width = `${progress}%`;
            }
        }

        // CAS Î≤àÌò∏ ÌëúÏ§ÄÌôî Ìï®Ïàò
        function standardizeCASNumber(casNumber) {
            if (!casNumber || typeof casNumber !== 'string') {
                return { 
                    standardized: null, 
                    isValid: false, 
                    issues: ['CAS Î≤àÌò∏Í∞Ä ÎàÑÎùΩÎêòÏóàÏäµÎãàÎã§.'] 
                };
            }
            
            const cleaned = casNumber.trim().replace(/[^0-9-]/g, '');
            const issues = [];
            
            // Í∏∞Î≥∏ ÌòïÏãù Í≤ÄÏ¶ù
            const casRegex = /^\\d{2,7}-\\d{2}-\\d$/;
            
            if (casRegex.test(cleaned)) {
                // Ï≤¥ÌÅ¨ÏÑ¨ Í≤ÄÏ¶ù
                const parts = cleaned.split('-');
                const digits = (parts[0] + parts[1]).split('').reverse();
                const checkDigit = parseInt(parts[2]);
                
                let sum = 0;
                for (let i = 0; i < digits.length; i++) {
                    sum += parseInt(digits[i]) * (i + 1);
                }
                
                const calculatedCheck = sum % 10;
                
                if (calculatedCheck === checkDigit) {
                    return { 
                        standardized: cleaned, 
                        isValid: true, 
                        issues: [] 
                    };
                } else {
                    issues.push(`CAS Î≤àÌò∏ Ï≤¥ÌÅ¨ÏÑ¨ Ïò§Î•ò (Í≥ÑÏÇ∞Í∞í: ${calculatedCheck}, ÏûÖÎ†•Í∞í: ${checkDigit})`);
                }
            }
            
            // ÏûêÎèô ÏàòÏ†ï ÏãúÎèÑ
            if (/^\\d{5,9}$/.test(cleaned)) {
                const digits = cleaned;
                if (digits.length >= 7) {
                    const suggested = `${digits.slice(0, -3)}-${digits.slice(-3, -1)}-${digits.slice(-1)}`;
                    return {
                        standardized: suggested,
                        isValid: false,
                        issues: [`ÌòïÏãù Ïò§Î•ò - Ï†úÏïàÍ∞í: ${suggested}`],
                        autoFixSuggestion: suggested
                    };
                }
            }
            
            return {
                standardized: cleaned,
                isValid: false,
                issues: ['CAS Î≤àÌò∏ ÌòïÏãùÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.']
            };
        }

        // ÏÑ±Î∂ÑÎ™Ö Ï†ïÍ∑úÌôî Ìï®Ïàò
        function normalizeIngredientName(name) {
            if (!name || typeof name !== 'string') {
                return {
                    normalized: null,
                    isValid: false,
                    issues: ['ÏÑ±Î∂ÑÎ™ÖÏù¥ ÎàÑÎùΩÎêòÏóàÏäµÎãàÎã§.']
                };
            }
            
            const issues = [];
            let normalized = name.trim();
            
            // Í≥µÌÜµ Ï†ïÍ∑úÌôî Í∑úÏπô
            const normalizationRules = [
                { pattern: /ÏÜåÎìê/g, replacement: 'ÎÇòÌä∏Î•®' },
                { pattern: /Ìè¨ÌÉÄÏäò/g, replacement: 'ÏπºÎ•®' },
                { pattern: /ÌÅ¥Î°úÎùºÏù¥Îìú/g, replacement: 'ÏóºÌôîÎ¨º' },
                { pattern: /ÏÑ§ÌéòÏù¥Ìä∏/g, replacement: 'Ìô©ÏÇ∞Ïóº' },
                { pattern: /ÌïòÏù¥ÎìúÎ°ùÏÇ¨Ïù¥Îìú/g, replacement: 'ÏàòÏÇ∞ÌôîÎ¨º' },
                { pattern: /\\s+/g, replacement: ' ' },
                { pattern: /^\\s+|\\s+$/g, replacement: '' }
            ];
            
            let wasNormalized = false;
            const originalName = normalized;
            
            normalizationRules.forEach(rule => {
                const newValue = normalized.replace(rule.pattern, rule.replacement);
                if (newValue !== normalized) {
                    normalized = newValue;
                    wasNormalized = true;
                }
            });
            
            // Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
            if (normalized.length < 2) {
                issues.push('ÏÑ±Î∂ÑÎ™ÖÏù¥ ÎÑàÎ¨¥ ÏßßÏäµÎãàÎã§.');
            }
            
            if (/[0-9]{5,}/.test(normalized)) {
                issues.push('ÏÑ±Î∂ÑÎ™ÖÏóê Í∏¥ Ïà´ÏûêÍ∞Ä Ìè¨Ìï®ÎêòÏñ¥ ÏûàÏäµÎãàÎã§.');
            }
            
            if (/ÏûòÎ™ªÎêú|Ïò§Î•ò|ÏóêÎü¨|unknown/i.test(normalized)) {
                issues.push('ÏÑ±Î∂ÑÎ™ÖÏóê Ïò§Î•ò ÌëúÏãúÍ∞Ä Ìè¨Ìï®ÎêòÏñ¥ ÏûàÏäµÎãàÎã§.');
            }
            
            return {
                normalized: normalized,
                isValid: issues.length === 0,
                issues: issues,
                wasNormalized: wasNormalized,
                originalValue: wasNormalized ? originalName : null
            };
        }

        // Ìï®Îüâ Í≤ÄÏ¶ù Ìï®Ïàò
        function validatePercentage(percentage) {
            const issues = [];
            
            if (percentage === null || percentage === undefined || percentage === '') {
                return {
                    validated: null,
                    isValid: false,
                    issues: ['Ìï®Îüâ Ï†ïÎ≥¥Í∞Ä ÎàÑÎùΩÎêòÏóàÏäµÎãàÎã§.']
                };
            }
            
            const numValue = parseFloat(percentage);
            
            if (isNaN(numValue)) {
                issues.push('Ìï®ÎüâÏù¥ Ïà´ÏûêÍ∞Ä ÏïÑÎãôÎãàÎã§.');
                return {
                    validated: percentage,
                    isValid: false,
                    issues: issues
                };
            }
            
            let validated = numValue;
            
            // Î≤îÏúÑ Í≤ÄÏ¶ù
            if (numValue < 0) {
                issues.push('Ìï®ÎüâÏù¥ ÏùåÏàòÏûÖÎãàÎã§.');
                // ÏûêÎèô ÏàòÏ†ï Ï†úÏïà
                return {
                    validated: validated,
                    isValid: false,
                    issues: issues,
                    autoFixSuggestion: Math.abs(numValue)
                };
            }
            
            if (numValue > 100) {
                issues.push('Ìï®ÎüâÏù¥ 100%Î•º Ï¥àÍ≥ºÌï©ÎãàÎã§.');
            }
            
            // ÏÜåÏàòÏ†ê ÏûêÎ¶¨Ïàò Ï†ïÍ∑úÌôî
            if (numValue % 1 !== 0) {
                validated = Math.round(numValue * 100) / 100; // ÏÜåÏàòÏ†ê 2ÏûêÎ¶¨ÍπåÏßÄ
            }
            
            return {
                validated: validated,
                isValid: issues.length === 0,
                issues: issues
            };
        }

        // Î†àÏΩîÎìú ÌëúÏ§ÄÌôî Ìï®Ïàò
        function standardizeRecord(record) {
            const issues = [];
            const standardized = { ...record };
            
            // CAS Î≤àÌò∏ ÌëúÏ§ÄÌôî
            if (record.cas_number) {
                const casResult = standardizeCASNumber(record.cas_number);
                standardized.cas_number = casResult.standardized;
                
                if (!casResult.isValid) {
                    issues.push({
                        id: `cas-${record.id}`,
                        type: 'error',
                        field: 'cas_number',
                        title: 'CAS Î≤àÌò∏ Ïò§Î•ò',
                        description: casResult.issues.join(', '),
                        originalValue: record.cas_number,
                        suggestedValue: casResult.autoFixSuggestion,
                        autoFixable: !!casResult.autoFixSuggestion
                    });
                }
            }
            
            // ÏÑ±Î∂ÑÎ™Ö Ï†ïÍ∑úÌôî
            if (record.ingredient_name) {
                const nameResult = normalizeIngredientName(record.ingredient_name);
                standardized.ingredient_name = nameResult.normalized;
                
                if (!nameResult.isValid) {
                    issues.push({
                        id: `name-${record.id}`,
                        type: 'warning',
                        field: 'ingredient_name',
                        title: 'ÏÑ±Î∂ÑÎ™Ö Ïù¥Ïäà',
                        description: nameResult.issues.join(', '),
                        originalValue: record.ingredient_name,
                        suggestedValue: nameResult.normalized,
                        autoFixable: nameResult.wasNormalized
                    });
                } else if (nameResult.wasNormalized) {
                    issues.push({
                        id: `name-normalized-${record.id}`,
                        type: 'suggestion',
                        field: 'ingredient_name',
                        title: 'ÏÑ±Î∂ÑÎ™Ö Ï†ïÍ∑úÌôî',
                        description: 'ÏÑ±Î∂ÑÎ™ÖÏù¥ ÌëúÏ§Ä ÌòïÌÉúÎ°ú Ï†ïÍ∑úÌôîÎêòÏóàÏäµÎãàÎã§.',
                        originalValue: nameResult.originalValue,
                        suggestedValue: nameResult.normalized,
                        autoFixable: true
                    });
                }
            }
            
            // Ìï®Îüâ Í≤ÄÏ¶ù
            if (record.percentage !== undefined) {
                const percentResult = validatePercentage(record.percentage);
                standardized.percentage = percentResult.validated;
                
                if (!percentResult.isValid) {
                    issues.push({
                        id: `percentage-${record.id}`,
                        type: percentResult.autoFixSuggestion ? 'warning' : 'error',
                        field: 'percentage',
                        title: 'Ìï®Îüâ Ïò§Î•ò',
                        description: percentResult.issues.join(', '),
                        originalValue: record.percentage,
                        suggestedValue: percentResult.autoFixSuggestion,
                        autoFixable: !!percentResult.autoFixSuggestion
                    });
                }
            }
            
            return {
                standardized: standardized,
                issues: issues
            };
        }

        // Ïù¥Ïäà ÌëúÏãú Ìï®Ïàò
        function displayIssues(issues) {
            const container = document.getElementById('issues-display');
            container.innerHTML = '';
            
            if (issues.length === 0) {
                container.innerHTML = '<div class="log-entry log-success">Í∞êÏßÄÎêú Ïù¥ÏäàÍ∞Ä ÏóÜÏäµÎãàÎã§! üéâ</div>';
                return;
            }
            
            const groupedIssues = issues.reduce((groups, issue) => {
                const key = issue.type;
                if (!groups[key]) groups[key] = [];
                groups[key].push(issue);
                return groups;
            }, {});
            
            Object.entries(groupedIssues).forEach(([type, typeIssues]) => {
                const groupHeader = document.createElement('div');
                groupHeader.innerHTML = `<h4 style="margin: 20px 0 10px 0; color: #374151;">${type.toUpperCase()} (${typeIssues.length}Í±¥)</h4>`;
                container.appendChild(groupHeader);
                
                typeIssues.forEach(issue => {
                    const issueElement = document.createElement('div');
                    issueElement.className = `issue-item issue-${issue.type}`;
                    
                    issueElement.innerHTML = `
                        <div class="issue-header">
                            <div class="issue-title">${issue.title}</div>
                            <span class="issue-type type-${issue.type}">${issue.type}</span>
                        </div>
                        <div class="issue-details">
                            <strong>ÏÑ§Î™Ö:</strong> ${issue.description}<br>
                            <strong>ÌïÑÎìú:</strong> ${issue.field}<br>
                            ${issue.originalValue ? `<strong>ÏõêÎ≥∏Í∞í:</strong> ${issue.originalValue}<br>` : ''}
                            ${issue.suggestedValue ? `<strong>Ï†úÏïàÍ∞í:</strong> ${issue.suggestedValue}<br>` : ''}
                            <strong>ÏûêÎèôÏàòÏ†ï:</strong> ${issue.autoFixable ? 'Í∞ÄÎä•' : 'Î∂àÍ∞ÄÎä•'}
                        </div>
                        ${issue.suggestedValue ? `
                            <div class="fix-preview">
                                <div class="fix-before">- ${issue.originalValue}</div>
                                <div class="fix-after">+ ${issue.suggestedValue}</div>
                            </div>
                        ` : ''}
                        <div class="issue-actions">
                            ${issue.autoFixable ? `<button class="btn btn-success btn-small" onclick="applyFix('${issue.id}')">ÏàòÏ†ï Ï†ÅÏö©</button>` : ''}
                            <button class="btn btn-secondary btn-small" onclick="ignoreIssue('${issue.id}')">Î¨¥Ïãú</button>
                        </div>
                    `;
                    
                    container.appendChild(issueElement);
                });
            });
        }

        // ÌÖåÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
        function createTestData() {
            return [
                {
                    id: 'test-1',
                    product_name: 'Îã§Î™©Ï†Å ÏÑ∏Ï†ú',
                    ingredient_name: 'ÏÜåÎìêÎùºÏö∞Î¶¥ÏÑ§ÌéòÏù¥Ìä∏',
                    cas_number: '151213',
                    percentage: 15.5,
                    category: 'ÏÑ∏Ï†ú'
                },
                {
                    id: 'test-2',
                    product_name: 'ÏÜêÏÑ∏Ï†ïÏ†ú',
                    ingredient_name: 'ÏóêÌã∏ÏïåÏΩîÏò¨',
                    cas_number: '64-17-5',
                    percentage: -5,
                    category: 'ÏÑ∏Ï†ïÏ†ú'
                },
                {
                    id: 'test-3',
                    product_name: 'Ïú†Î¶¨ÏÑ∏Ï†ïÏ†ú',
                    ingredient_name: 'ÏûòÎ™ªÎêúÏÑ±Î∂ÑÎ™Ö',
                    cas_number: '123-45-6',
                    percentage: 105,
                    category: 'ÏÑ∏Ï†ïÏ†ú'
                },
                {
                    id: 'test-4',
                    product_name: 'Î∞îÎã•ÏÑ∏Ï†ïÏ†ú',
                    ingredient_name: 'ÏïîÎ™®ÎãàÏïÑ',
                    cas_number: '7664-41-7',
                    percentage: 8.25,
                    category: 'ÏÑ∏Ï†ïÏ†ú'
                },
                {
                    id: 'test-5',
                    product_name: 'ÌôîÏû•Ïã§ÏÑ∏Ï†ïÏ†ú',
                    ingredient_name: 'Ìè¨ÌÉÄÏäòÌïòÏù¥ÎìúÎ°ùÏÇ¨Ïù¥Îìú',
                    cas_number: '',
                    percentage: null,
                    category: 'ÏÑ∏Ï†ïÏ†ú'
                }
            ];
        }

        // ÏôÑÏ†Ñ ÌëúÏ§ÄÌôî Ïã§Ìñâ
        async function startFullStandardization() {
            if (standardizationState.isRunning) {
                addLog('ÌëúÏ§ÄÌôîÍ∞Ä Ïù¥ÎØ∏ Ïã§Ìñâ Ï§ëÏûÖÎãàÎã§.', 'warning');
                return;
            }
            
            standardizationState.isRunning = true;
            addLog('ÏôÑÏ†Ñ ÌëúÏ§ÄÌôîÎ•º ÏãúÏûëÌï©ÎãàÎã§...', 'info');
            
            // ÌÖåÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            const testData = createTestData();
            standardizationState.totalRecords = testData.length;
            standardizationState.processedRecords = 0;
            standardizationState.issues = [];
            
            updateStats();
            
            // Í∞Å Îã®Í≥Ñ Ïã§Ìñâ
            for (let i = 0; i < STANDARDIZATION_STAGES.length; i++) {
                const stage = STANDARDIZATION_STAGES[i];
                
                addLog(`Îã®Í≥Ñ ${i + 1}: ${stage.name} ÏãúÏûë`, 'info');
                updateStageStatus(stage.id, 'running');
                
                // Îã®Í≥ÑÎ≥Ñ Ï≤òÎ¶¨ ÏãúÎÆ¨Î†àÏù¥ÏÖò
                await simulateStageExecution(stage, testData);
                
                updateStageStatus(stage.id, 'completed', 100);
                addLog(`Îã®Í≥Ñ ${i + 1}: ${stage.name} ÏôÑÎ£å`, 'success');
            }
            
            standardizationState.isRunning = false;
            addLog('ÌëúÏ§ÄÌôîÍ∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!', 'success');
            updateStats();
        }

        // Îã®Í≥Ñ Ïã§Ìñâ ÏãúÎÆ¨Î†àÏù¥ÏÖò
        async function simulateStageExecution(stage, data) {
            const stepCount = 10;
            
            for (let step = 0; step < stepCount; step++) {
                await new Promise(resolve => setTimeout(resolve, 200));
                
                const progress = ((step + 1) / stepCount) * 100;
                updateStageStatus(stage.id, 'running', progress);
                
                // ÌäπÏ†ï Îã®Í≥ÑÏóêÏÑú Ïã§Ï†ú Ï≤òÎ¶¨ ÏàòÌñâ
                if (stage.id === 'cas-standardization' && step === 5) {
                    data.forEach(record => {
                        const result = standardizeRecord(record);
                        standardizationState.issues.push(...result.issues);
                    });
                    
                    displayIssues(standardizationState.issues);
                }
                
                if (step === stepCount - 1) {
                    standardizationState.processedRecords = Math.min(
                        standardizationState.processedRecords + Math.ceil(data.length / STANDARDIZATION_STAGES.length),
                        standardizationState.totalRecords
                    );
                    updateStats();
                }
            }
        }

        // Îπ†Î•∏ Í≤ÄÏ¶ù
        async function startQuickValidation() {
            addLog('Îπ†Î•∏ Í≤ÄÏ¶ùÏùÑ ÏãúÏûëÌï©ÎãàÎã§...', 'info');
            
            const testData = createTestData();
            const allIssues = [];
            
            testData.forEach(record => {
                const result = standardizeRecord(record);
                allIssues.push(...result.issues);
            });
            
            standardizationState.issues = allIssues;
            standardizationState.totalRecords = testData.length;
            standardizationState.processedRecords = testData.length;
            
            updateStats();
            displayIssues(allIssues);
            
            addLog(`Îπ†Î•∏ Í≤ÄÏ¶ù ÏôÑÎ£å: ${allIssues.length}Í±¥Ïùò Ïù¥Ïäà Î∞úÍ≤¨`, 'success');
        }

        // ÏàòÏ†ï Ï†ÅÏö©
        function applyFix(issueId) {
            addLog(`Ïù¥Ïäà ${issueId}Ïóê ÎåÄÌïú ÏàòÏ†ïÏùÑ Ï†ÅÏö©ÌñàÏäµÎãàÎã§.`, 'success');
            
            // Ìï¥Îãπ Ïù¥ÏäàÎ•º 'fixed' ÏÉÅÌÉúÎ°ú Î≥ÄÍ≤Ω
            const issue = standardizationState.issues.find(i => i.id === issueId);
            if (issue) {
                issue.type = 'fixed';
                issue.title = '[ÏàòÏ†ïÎê®] ' + issue.title;
                displayIssues(standardizationState.issues);
            }
        }

        // Ïù¥Ïäà Î¨¥Ïãú
        function ignoreIssue(issueId) {
            standardizationState.issues = standardizationState.issues.filter(i => i.id !== issueId);
            displayIssues(standardizationState.issues);
            addLog(`Ïù¥Ïäà ${issueId}Î•º Î¨¥ÏãúÌñàÏäµÎãàÎã§.`, 'info');
        }

        // ÌÖåÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        function loadTestData() {
            addLog('ÌÖåÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞Î•º Î°úÎìúÌï©ÎãàÎã§...', 'info');
            const testData = createTestData();
            addLog(`${testData.length}Í∞úÏùò ÌÖåÏä§Ìä∏ Î†àÏΩîÎìúÎ•º Î°úÎìúÌñàÏäµÎãàÎã§.`, 'success');
        }

        // Í≤∞Í≥º ÎÇ¥Î≥¥ÎÇ¥Í∏∞
        function exportResults() {
            const results = {
                timestamp: new Date().toISOString(),
                totalRecords: standardizationState.totalRecords,
                processedRecords: standardizationState.processedRecords,
                issues: standardizationState.issues,
                summary: {
                    errorCount: standardizationState.issues.filter(i => i.type === 'error').length,
                    warningCount: standardizationState.issues.filter(i => i.type === 'warning').length,
                    suggestionCount: standardizationState.issues.filter(i => i.type === 'suggestion').length,
                    fixedCount: standardizationState.issues.filter(i => i.type === 'fixed').length
                }
            };
            
            const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `standardization-results-${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            addLog('Í≤∞Í≥ºÎ•º JSON ÌååÏùºÎ°ú ÎÇ¥Î≥¥ÎÉàÏäµÎãàÎã§.', 'success');
        }

        // Ï†ÑÏ≤¥ Ï¥àÍ∏∞Ìôî
        function resetAll() {
            standardizationState = {
                isRunning: false,
                currentStage: 0,
                totalRecords: 0,
                processedRecords: 0,
                issues: [],
                stages: [],
                results: {}
            };
            
            updateStats();
            
            // Î™®Îì† Îã®Í≥Ñ Ï¥àÍ∏∞Ìôî
            STANDARDIZATION_STAGES.forEach(stage => {
                updateStageStatus(stage.id, 'pending', 0);
            });
            
            document.getElementById('issues-display').innerHTML = '<div class="log-entry log-info">Ïù¥ÏäàÍ∞Ä Í∞êÏßÄÎêòÎ©¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§.</div>';
            document.getElementById('logs').innerHTML = '';
            
            addLog('ÏãúÏä§ÌÖúÏù¥ Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§.', 'info');
        }

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', function() {
            createStagesUI();
            updateStats();
            addLog('ÌëúÏ§ÄÌôî ÏóîÏßÑÏù¥ Ï§ÄÎπÑÎêòÏóàÏäµÎãàÎã§.', 'success');
        });
    </script>
</body>
</html>